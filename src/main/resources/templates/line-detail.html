<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <meta charset="UTF-8">
  <title th:text="'ë…¸ì„  ìƒì„¸ - ' + ${line.name}">ë…¸ì„  ìƒì„¸</title>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c238cad9fda3d9da4d91990d3ebbb7be&autoload=false&libraries=services"></script>

  <style>
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
      border: 1px solid #ccc;
    }

    .arrival-dropdown {
      margin-top: 6px;
      font-size: 14px;
      padding: 4px;
    }
  </style>
</head>
<body>
<main layout:fragment="content">
  <div class="container">

    <!-- ğŸ”½ ë…¸ì„  ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
    <label for="lineSelect"><strong>ë…¸ì„  ì„ íƒ:</strong></label>
    <select id="lineSelect" onchange="location.href='/station/' + this.value">
      <option th:each="l : ${allLines}"
              th:value="${l.id}"
              th:text="${l.name}"
              th:selected="${l.id} == ${line.id}">
      </option>
    </select>

    <h2 th:text="'ğŸšŒ ' + ${line.name} + ' ì •ë¥˜ì¥ ëª©ë¡'">ë…¸ì„  ì´ë¦„</h2>
    <p th:text="'ë°°ì°¨: ' + ${line.dispatchNumber}">ë°°ì°¨ ì •ë³´</p>

    <ul>
      <li th:each="ls : ${stops}">
        <strong th:text="${ls.stop.name}">ì •ë¥˜ì¥ ì´ë¦„</strong>
        <span th:text="'(' + ${#temporals.format(ls.stop.arriveTime, 'HH:mm')} + ' ë„ì°©)'">ë„ì°© ì‹œê°„</span>

        <!-- ì§€ë„ ë³´ê¸° ë²„íŠ¼ -->
        <button type="button"
                style="margin-left: 10px;"
                th:attr="data-lat=${ls.stop.latitude}, data-lng=${ls.stop.longitude}, data-name=${ls.stop.name}"
                onclick="handleMapButtonClick(this)">
          ì§€ë„ ë³´ê¸°
        </button>

        <!-- ì‹œê°„ ë³´ê¸° ë²„íŠ¼ -->
        <button type="button"
                style="margin-left: 10px;"
                th:attr="data-times=${stopTimeMap[ls.stop.name]}"
                onclick="toggleDropdown(this)">
          ì‹œê°„ ë³´ê¸°
        </button>

        <!-- ë“œë¡­ë‹¤ìš´ (ë¹„ì–´ ìˆìŒ, JSì—ì„œ ì±„ì›€) -->
        <select class="arrival-dropdown" style="display: none;"></select>
      </li>
      <li th:if="${#lists.isEmpty(stops)}">ğŸ“­ ë“±ë¡ëœ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</li>
    </ul>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>
  </div>

  <!-- JS -->
  <script>
    kakao.maps.load(function () {
      let map;

      window.handleMapButtonClick = function (btn) {
        const lat = parseFloat(btn.getAttribute('data-lat'));
        const lng = parseFloat(btn.getAttribute('data-lng'));
        const name = btn.getAttribute('data-name');
        showMap(lat, lng, name);
      }

      function showMap(lat, lng, name) {
        const container = document.getElementById('map');
        const options = {
          center: new kakao.maps.LatLng(lat, lng),
          level: 3
        };

        map = new kakao.maps.Map(container, options);

        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(lat, lng)
        });
        marker.setMap(map);

        const infowindow = new kakao.maps.InfoWindow({
          content: '<div style="padding:5px;">' + name + '</div>'
        });
        infowindow.open(map, marker);
      }
    });

    // ë„ì°©ì‹œê°„ ë“œë¡­ë‹¤ìš´ í† ê¸€
    function toggleDropdown(button) {
      const select = button.nextElementSibling;
      const raw = button.getAttribute('data-times');
      const times = raw.replaceAll("'", "\"").replace("[", "").replace("]", "").split(", ");

      select.innerHTML = "";
      times.forEach(time => {
        const option = document.createElement("option");
        option.value = time.trim();
        option.textContent = time.trim();
        select.appendChild(option);
      });

      select.style.display = (select.style.display === 'none') ? 'inline-block' : 'none';
    }
  </script>
</main>
</body>
</html>
