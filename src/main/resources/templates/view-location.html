<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>ë²„ìŠ¤ ìœ„ì¹˜ ë³´ê¸°</title>
    <th:block layout:fragment="head-extra">
        <style>
            #map {
                width: 100%;
                height: 400px;
                margin-top: 20px;
                border: 1px solid #ccc;
            }
        </style>
    </th:block>
</head>
<body>
<main layout:fragment="content">
    <h2>ğŸ“ ë²„ìŠ¤ ìœ„ì¹˜ ë³´ê¸°</h2>
    <div id="map">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <script>
        let map;
        let marker;
        let infowindow;

        kakao.maps.load(function () {
            // ì´ˆê¸° ì§€ë„ ì¤‘ì‹¬: ì„œìš¸ ì‹œì²­
            const defaultCenter = new kakao.maps.LatLng(37.5665, 126.9780);

            map = new kakao.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                level: 4
            });

            updateMarker();
            setInterval(updateMarker, 2000); // âœ… 2ì´ˆë§ˆë‹¤ ìµœì‹  ìœ„ì¹˜ ìš”ì²­
        });

        function updateMarker() {
            fetch('/api/location/latest')
                .then(res => res.json())
                .then(data => {
                    if (!data || typeof data.lat !== 'number' || typeof data.lng !== 'number') {
                        console.warn("ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    const latlng = new kakao.maps.LatLng(data.lat, data.lng);

                    if (!marker) {
                        marker = new kakao.maps.Marker({
                            map: map,
                            position: latlng
                        });

                        infowindow = new kakao.maps.InfoWindow({
                            content: '<div style="padding:5px;">ğŸ“ ë²„ìŠ¤ í˜„ì¬ ìœ„ì¹˜</div>'
                        });

                        infowindow.open(map, marker);
                    } else {
                        marker.setPosition(latlng);
                        infowindow.setPosition(latlng);
                    }

                    map.setCenter(latlng);
                })
                .catch(err => {
                    console.error("ìœ„ì¹˜ ìš”ì²­ ì‹¤íŒ¨:", err);
                });
        }
    </script>
</main>
</body>
</html>
